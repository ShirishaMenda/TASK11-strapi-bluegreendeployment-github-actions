name: CD - ECS Blue Green Deploy

on:
  workflow_run:
    workflows: ["CI - Build & Push Docker Image"]
    types: [completed]

jobs:
  deploy:
    if: ${{ github.event.workflow_run.conclusion == 'success' }}
    runs-on: ubuntu-latest

    steps:
    - uses: actions/checkout@v4

    - uses: actions/download-artifact@v4
      with:
        name: image_uri
        path: .
        run-id: ${{ github.event.workflow_run.id }}
        github-token: ${{ secrets.GITHUB_TOKEN }}

    - name: Set Image URI
      run: |
        IMAGE_URI=$(cat image_uri.txt)
        echo "IMAGE_URI=$IMAGE_URI" >> $GITHUB_ENV

    - uses: aws-actions/configure-aws-credentials@v4
      with:
        aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
        aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
        aws-region: us-east-1

    # -----------------------------
    # Create New Task Definition
    # -----------------------------
    - name: Fetch current task definition
      run: |
        aws ecs describe-task-definition \
          --task-definition ecs-bluegreen-task \
          --query taskDefinition > taskdef.json

    - name: Update image in task definition
      run: |
        jq --arg IMAGE "$IMAGE_URI" \
          '.containerDefinitions[0].image=$IMAGE |
           del(.taskDefinitionArn,.revision,.status,.requiresAttributes,.compatibilities,.registeredAt,.registeredBy)' \
           taskdef.json > new-taskdef.json

    - name: Register new task definition
      run: |
        aws ecs register-task-definition \
          --cli-input-json file://new-taskdef.json

    # -----------------------------
    # Create AppSpec.json
    # -----------------------------
    - name: Create appspec.json
      run: |
        TASK_DEF_ARN=$(aws ecs describe-task-definition \
          --task-definition ecs-bluegreen-task \
          --query "taskDefinition.taskDefinitionArn" \
          --output text)

        cat <<EOF > appspec.json
        {
         "version": 1,
          "Resources": [
        {
          "TargetService": {
          "Type": "AWS::ECS::Service",
           "Properties": {
          "TaskDefinition": "$TASK_DEF_ARN",
          "LoadBalancerInfo": {
            "ContainerName": "strapi",
            "ContainerPort": 1337
          }
        }
        }
        }
        ]
        }
        EOF

    # -----------------------------
    # Trigger CodeDeploy Deployment
    # -----------------------------
    - name: Deploy using CodeDeploy
      run: |
        # Base64 encode JSON with no newlines
        APP_SPEC_CONTENT=$(base64 -w0 appspec.json)

        # Correct SHA256 hash
        SHA=$(openssl dgst -sha256 appspec.json | awk '{print $2}')

        aws deploy create-deployment \
          --application-name ecs-bluegreen-codedeploy \
          --deployment-group-name ecs-bluegreen-dg \
          --deployment-config-name CodeDeployDefault.ECSAllAtOnce \
          --revision "revisionType=AppSpecContent,appSpecContent={content=$APP_SPEC_CONTENT,sha256=$SHA}"

    # -----------------------------
    # Monitor Deployment
    # -----------------------------
    - name: Wait for deployment
      run: |
        DEPLOY_ID=$(aws deploy list-deployments \
          --application-name ecs-bluegreen-codedeploy \
          --query "deployments[0]" \
          --output text)

        echo "Deployment ID: $DEPLOY_ID"

        aws deploy wait deployment-successful \
          --deployment-id $DEPLOY_ID

        echo "Deployment completed successfully!"